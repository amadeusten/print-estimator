<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen">
        <div id="main-panel" class="flex-grow p-6 overflow-y-auto transition-all duration-300">
            <!-- Error Message -->
            <div id="error-message" class="mb-4 text-red-600 text-sm font-semibold bg-red-100 p-3 rounded-md hidden"></div>

            <!-- Inputs Section -->
            <div class="space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="description" class="text-xs font-medium text-gray-600">Description</label>
                        <textarea id="description" class="mt-1 w-full p-2 border border-gray-300 rounded-md hover:bg-gray-50 text-sm" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Material</label>
                        <select id="material" class="mt-1 h-9 w-full p-2 border border-gray-300 rounded-md hover:bg-gray-50 text-sm">
                            <option value="" disabled selected>Select a material</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label for="quantity" class="text-xs font-medium text-gray-600">Qty</label>
                            <input id="quantity" type="number" value="1" min="1" class="mt-1 h-9 p-2 border border-gray-300 rounded-md w-full" placeholder="1" />
                        </div>
                        <div>
                            <label for="width" class="text-xs font-medium text-gray-600">Width</label>
                            <input id="width" type="number" min="0" class="mt-1 h-9 p-2 border border-gray-300 rounded-md w-full" placeholder="0" />
                        </div>
                        <div>
                            <label for="height" class="text-xs font-medium text-gray-600">Height</label>
                            <input id="height" type="number" min="0" class="mt-1 h-9 p-2 border border-gray-300 rounded-md w-full" placeholder="0"/>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Options</label>
                        <div id="options-container" class="flex flex-wrap gap-2 mt-2">
                            <button data-option="complexShape" class="flex items-center gap-2 rounded-md px-3 py-1 text-sm transition-colors bg-gray-200 hover:bg-gray-300">Complex Shape</button>
                            <button data-option="doubleSided" class="flex items-center gap-2 rounded-md px-3 py-1 text-sm transition-colors bg-gray-200 hover:bg-gray-300">Double Sided</button>
                            <button data-option="lamination" class="flex items-center gap-2 rounded-md px-3 py-1 text-sm transition-colors bg-gray-200 hover:bg-gray-300">Lamination</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="mt-6 flex flex-col justify-between rounded-md bg-gray-100 p-3">
                <div class="grid sm:grid-cols-[1fr_auto_1fr] items-center gap-x-4 gap-y-4 h-full">
                    <div class="space-y-2">
                        <div class="grid grid-cols-2 items-center"><div class="text-sm">Total Cost</div><div id="total-cost" class="text-sm text-left font-semibold">$0.00</div></div>
                        <div class="grid grid-cols-2 items-center">
                            <div class="text-sm">Margin</div>
                            <div class="relative w-20">
                                <input id="margin" type="number" value="60" min="0" step="1" class="w-full h-8 p-2 pr-6 border border-gray-300 rounded-md" placeholder="Value" />
                                <span class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 items-center"><div class="text-sm">Total Price</div><div id="total-price" class="text-sm text-left font-semibold">$0.00</div></div>
                        <div class="grid grid-cols-2 items-center"><div class="text-sm">Unit Price</div><div id="unit-price" class="text-sm text-left font-semibold">$0.00</div></div>
                    </div>
                    <div class="hidden sm:flex justify-center h-full"><div class="border-l border-gray-300"></div></div>
                    <div class="flex flex-col justify-center items-center gap-2.5">
                        <button id="add-to-project-btn" class="w-full h-9 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700">Add to Project</button>
                        <button id="reset-btn" class="w-full h-9 bg-gray-200 text-gray-800 rounded-md text-sm hover:bg-gray-300">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Settings Trigger -->
        <div id="drawer-trigger" class="flex-shrink-0 bg-gray-100 hover:bg-gray-200 transition-colors cursor-pointer flex items-center justify-center w-10">
            <div class="flex flex-col items-center gap-2">
                <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                <span class="text-xs font-medium text-gray-500" style="writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);">Advanced Settings</span>
            </div>
        </div>
    </div>

    <!-- Advanced Settings Drawer -->
    <div id="drawer" class="fixed top-0 right-0 h-full bg-white shadow-lg transition-transform duration-300 ease-in-out translate-x-full z-10" style="width: 275px;">
        <div class="p-4 border-b flex justify-between items-center">
            <h2 class="text-lg font-semibold">Advanced Settings</h2>
            <button id="drawer-close-btn" class="p-1 rounded-full hover:bg-gray-200 transition-colors">
                <svg class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="advanced-fields-container" class="p-4 space-y-4">
            <!-- Advanced fields will be injected here -->
        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            materials: [], materialName: '', description: '', quantity: 1, width: '', height: '',
            complexShape: false, doubleSided: false, lamination: false,
            designTime: '', laborDecalsTime: '', laborFinishingTime: '', laborInstallingTime: '',
            designTimeUnit: 'Minutes', laborDecalsTimeUnit: 'Minutes', laborFinishingTimeUnit: 'Minutes', laborInstallingTimeUnit: 'Minutes',
            margin: 60, isDrawerOpen: false,
        };

        // --- Helper Functions ---
        const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(isNaN(value) ? 0 : value);
        const getTimeInHours = (time, unit) => {
            const numTime = Number(time) || 0;
            return unit === 'Minutes' ? numTime / 60 : numTime;
        };

        // --- Calculation Logic ---
        function calculateEstimate() {
            const errorMessageDiv = document.getElementById('error-message');
            errorMessageDiv.textContent = '';
            errorMessageDiv.classList.add('hidden');

            const selectedMaterial = state.materials.find(m => m.name === state.materialName);

            if (!selectedMaterial || !state.quantity || !state.width || !state.height) {
                resetCostsUI();
                return;
            }
            
            const qty = Number(state.quantity) || 0;
            const artWidth = Number(state.width) || 0;
            const artHeight = Number(state.height) || 0;
            const bleed = 0.25;
            const spacing = 0.25;
            const artWidthTotal = artWidth + bleed;
            const artHeightTotal = artHeight + bleed;

            let materialCost = 0;
            let totalLinearFeet = 0;

            if (selectedMaterial.type === 'ROLL') {
                const rollWidth = selectedMaterial.width;
                if (artWidthTotal > rollWidth && artHeightTotal > rollWidth) {
                    errorMessageDiv.textContent = 'Artwork is wider than the selected roll.';
                    errorMessageDiv.classList.remove('hidden');
                    resetCostsUI();
                    return;
                }
                const linFtCost = selectedMaterial.costLinFt;
                const colsPortrait = Math.floor((rollWidth + spacing) / (artWidthTotal + spacing));
                const colsLandscape = Math.floor((rollWidth + spacing) / (artHeightTotal + spacing));
                let numColumns = Math.max(colsPortrait, colsLandscape, 1);
                let layoutRow = artHeightTotal;
                if (colsLandscape > colsPortrait) layoutRow = artWidthTotal;
                const numRows = Math.ceil(qty / numColumns);
                const totalLinearInches = (numRows * layoutRow) + ((numRows - 1) * spacing);
                totalLinearFeet = totalLinearInches / 12;
                materialCost = (totalLinearFeet + 2.5) * linFtCost;
            } else if (selectedMaterial.type === 'SHEET') {
                const sheetWidth = selectedMaterial.width;
                const sheetHeight = selectedMaterial.height;
                const artFitsPortrait = (artWidthTotal <= sheetWidth && artHeightTotal <= sheetHeight);
                const artFitsLandscape = (artWidthTotal <= sheetHeight && artHeightTotal <= sheetWidth);
                if (!artFitsPortrait && !artFitsLandscape) {
                    errorMessageDiv.textContent = 'Artwork is larger than the selected sheet.';
                    errorMessageDiv.classList.remove('hidden');
                    resetCostsUI();
                    return;
                }
                const sheetCost = selectedMaterial.costSheet;
                const perSheet1 = artFitsPortrait ? Math.floor((sheetWidth + spacing) / (artWidthTotal + spacing)) * Math.floor((sheetHeight + spacing) / (artHeightTotal + spacing)) : 0;
                const perSheet2 = artFitsLandscape ? Math.floor((sheetWidth + spacing) / (artHeightTotal + spacing)) * Math.floor((sheetHeight + spacing) / (artWidthTotal + spacing)) : 0;
                const piecesPerSheet = Math.max(perSheet1, perSheet2, 1);
                const totalSheets = Math.ceil(qty / piecesPerSheet);
                let calculatedMaterialCost = totalSheets * sheetCost;
                const halfSheetCost = sheetCost * 0.5;
                materialCost = Math.max(calculatedMaterialCost, halfSheetCost);
            }

            const singlePieceSqFt = (artWidthTotal * artHeightTotal) / 144;
            let totalArtworkSqFt = singlePieceSqFt * qty;
            if (state.doubleSided) totalArtworkSqFt *= 2;
            const totalArtworkPerimeter = (artWidth * 2 + artHeight * 2) * qty;
            const printTimeHours = (totalArtworkSqFt / 0.83) / 60;
            let cutTimeHours = (totalArtworkPerimeter / 120) / 60;
            if (state.complexShape) cutTimeHours *= 1.5;
            const ripTimeHours = (totalArtworkSqFt / 20.52) / 60;
            const printComputeTimeHours = (totalArtworkSqFt / 6.2) / 60;
            const designTimeInHours = getTimeInHours(state.designTime, state.designTimeUnit);
            const laborDecalsTimeInHours = getTimeInHours(state.laborDecalsTime, state.laborDecalsTimeUnit);
            const laborFinishingTimeInHours = getTimeInHours(state.laborFinishingTime, state.laborFinishingTimeUnit);
            const laborInstallingTimeInHours = getTimeInHours(state.laborInstallingTime, state.laborInstallingTimeUnit);
            const manualOperatorTimeInHours = laborDecalsTimeInHours + laborFinishingTimeInHours + laborInstallingTimeInHours;
            const totalProjectRunTimeHours = printTimeHours + cutTimeHours + ripTimeHours + printComputeTimeHours;
            const inkCost = totalArtworkSqFt * 0.165;
            const cuttingCost = cutTimeHours * 25.00;
            const baseDesignCost = (totalArtworkSqFt / 25) * 0.0625 * 60.00;
            const manualDesignCost = designTimeInHours * 60.00;
            const designCost = baseDesignCost + manualDesignCost;
            let laminationCost = 0;
            if (state.lamination) {
                if (selectedMaterial.type === 'ROLL') laminationCost = totalLinearFeet * 1.02;
                else laminationCost = totalArtworkSqFt * 0.2267;
            }
            const equipmentCost = totalProjectRunTimeHours * 4.95;
            const operatorCost = (totalProjectRunTimeHours + manualOperatorTimeInHours) * 28.00;
            const calculatedTotalCosts = materialCost + inkCost + cuttingCost + designCost + equipmentCost + operatorCost + laminationCost;
            const numMargin = Number(state.margin) || 0;
            let calculatedTotalPrice = calculatedTotalCosts;
            if (numMargin < 100 && numMargin >= 0) calculatedTotalPrice = calculatedTotalCosts / (1 - (numMargin / 100));
            const calculatedUnitPrice = qty > 0 ? calculatedTotalPrice / qty : 0;

            updateCostsUI(calculatedTotalCosts, calculatedTotalPrice, calculatedUnitPrice);
        }

        // --- UI Update Functions ---
        function updateCostsUI(total, price, unit) {
            document.getElementById('total-cost').textContent = formatCurrency(total);
            document.getElementById('total-price').textContent = formatCurrency(price);
            document.getElementById('unit-price').textContent = formatCurrency(unit);
        }

        function resetCostsUI() {
            updateCostsUI(0, 0, 0);
        }

        function resetForm() {
            Object.assign(state, {
                description: '', materialName: '', quantity: 1, width: '', height: '',
                complexShape: false, doubleSided: false, lamination: false,
                designTime: '', laborDecalsTime: '', laborFinishingTime: '', laborInstallingTime: '',
                designTimeUnit: 'Minutes', laborDecalsTimeUnit: 'Minutes', laborFinishingTimeUnit: 'Minutes', laborInstallingTimeUnit: 'Minutes',
                margin: 60, isDrawerOpen: false,
            });
            document.getElementById('description').value = '';
            document.getElementById('material').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('width').value = '';
            document.getElementById('height').value = '';
            document.getElementById('margin').value = '60';
            document.querySelectorAll('#options-container button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });
            document.querySelectorAll('#advanced-fields-container input').forEach(input => input.value = '');
            calculateEstimate();
        }

        function sendDataToProject() {
            const description = state.description || 'Description Details';
            const width = Number(state.width) || 0;
            const height = Number(state.height) || 0;
            const formattedDescription = `${description} - (${width}" x ${height}")`;

            const qty = Number(state.quantity) || 0;
            const priceText = document.getElementById('total-price').textContent;
            const totalPrice = parseFloat(priceText.replace(/[^0-9.-]+/g,""));
            const unitPrice = qty > 0 ? totalPrice / qty : 0;
            if (isNaN(qty) || isNaN(unitPrice) || isNaN(totalPrice) || qty === 0) {
                alert("Please enter a valid quantity before adding to the project.");
                return;
            }
            google.script.run.addEstimateToProject(formattedDescription, qty, unitPrice, totalPrice);
        }
        
        // --- DOM Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            google.script.run.withSuccessHandler(materials => {
                state.materials = materials.map(m => ({
                    name: m[0], type: m[1], width: parseFloat(m[2]), height: parseFloat(m[3]), costSheet: parseFloat(m[4]), costLinFt: parseFloat(m[5])
                }));
                const materialSelect = document.getElementById('material');
                state.materials.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.name;
                    option.textContent = m.name;
                    materialSelect.appendChild(option);
                });
            }).getMaterialInventory();

            // Setup all event listeners
            document.getElementById('description').addEventListener('input', (e) => { state.description = e.target.value; });
            document.getElementById('material').addEventListener('change', (e) => { state.materialName = e.target.value; calculateEstimate(); });
            ['quantity', 'width', 'height', 'margin'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => { state[id] = e.target.value; calculateEstimate(); });
            });
            document.querySelectorAll('#options-container button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const option = e.currentTarget.dataset.option;
                    state[option] = !state[option];
                    e.currentTarget.classList.toggle('bg-blue-600');
                    e.currentTarget.classList.toggle('text-white');
                    e.currentTarget.classList.toggle('bg-gray-200');
                    e.currentTarget.classList.toggle('hover:bg-gray-300');
                    calculateEstimate();
                });
            });
            document.getElementById('reset-btn').addEventListener('click', resetForm);
            document.getElementById('add-to-project-btn').addEventListener('click', sendDataToProject);
            
            // Advanced Drawer
            const drawer = document.getElementById('drawer');
            const mainPanel = document.getElementById('main-panel');
            const drawerTrigger = document.getElementById('drawer-trigger');
            const drawerCloseBtn = document.getElementById('drawer-close-btn');

            const toggleDrawer = () => {
                state.isDrawerOpen = !state.isDrawerOpen;
                drawer.classList.toggle('translate-x-full');
                mainPanel.parentElement.classList.toggle('max-w-5xl');
                mainPanel.parentElement.classList.toggle('max-w-2xl');
            };
            drawerTrigger.addEventListener('click', toggleDrawer);
            drawerCloseBtn.addEventListener('click', toggleDrawer);

            // Render advanced fields
            const advancedContainer = document.getElementById('advanced-fields-container');
            const advancedFields = [
                { id: 'designTime', label: 'Labor Design', unitId: 'designTimeUnit' },
                { id: 'laborDecalsTime', label: 'Labor Decals', unitId: 'laborDecalsTimeUnit' },
                { id: 'laborFinishingTime', label: 'Labor Finishing', unitId: 'laborFinishingTimeUnit' },
                { id: 'laborInstallingTime', label: 'Labor Installing', unitId: 'laborInstallingTimeUnit' },
            ];
            advancedFields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-[100px_1fr] items-center gap-2';
                div.innerHTML = `
                    <label for="${field.id}" class="text-sm">${field.label}</label>
                    <div class="flex gap-1">
                        <input id="${field.id}" type="number" min="0" step="0.25" class="h-9 w-full p-2 border rounded-md" placeholder="0">
                        <select id="${field.unitId}" class="h-9 border rounded-md p-2 text-sm">
                            <option value="Minutes">Minutes</option>
                            <option value="Hours">Hours</option>
                        </select>
                    </div>
                `;
                advancedContainer.appendChild(div);
                document.getElementById(field.id).addEventListener('input', (e) => { state[field.id] = e.target.value; calculateEstimate(); });
                document.getElementById(field.unitId).addEventListener('change', (e) => { state[field.unitId] = e.target.value; calculateEstimate(); });
            });
        });
    </script>
</body>
</html>
